<!DOCTYPE html>
<html lang="en">
<head>
<title>Masq Storage Client</title>
</head>
<body>
  <h1>ACME Masq App</h1>
  <p>
    <pre id="data"></pre>
  </p>
</body>
<script type="text/javascript" src="dist/masq.js"></script>
<script>
var pre = document.getElementById('data')
var STORE = 'http://localhost:8081/'
var appURL = window.location.origin + window.location.pathname
var regParams = {
  endpoint: STORE,
  url: appURL,
  title: 'ACME app',
  desc: 'A generic app that uses Masq for storage',
  icon: 'http://localhost:8081/img/logo.png'
}

var masqStore = new window.MasqClient(STORE)

// Your app data (store)
var appData = {}
// Connect to the store
masqStore.onConnect().then(getRemoteData)

// Register app if it's the first time we use it
var register = function () {
  var errMsg = document.createElement('span')
  errMsg.id = 'err-msg'
  errMsg.innerHTML = 'Click <a href="#" id="register-app">here</a> to register your application with Masq'
  document.body.appendChild(errMsg)
  document.getElementById('register-app').addEventListener('click', function () {
    masqStore.registerApp(regParams).then(function (e) {
      // window.location.reload()
      errMsg.remove()
      getRemoteData()
    })
  })
}

// Load all remote app state on initial connect
var getRemoteData = function () {
  return masqStore.getAll().then(function (res) {
    var errMsg = document.getElementById('err-msg')
    if (errMsg) {
      errMsg.remove()
    }
    // update your local store
    appData = res || appData
    console.log('Loaded app state:', appData)
    pre.innerText = JSON.stringify(appData)
  }).catch(function (err) {
    if (err.message === 'UNREGISTERED') {
      register()
    }
    console.log(err.message)
  })
}

// Refresh app state following a sync event
document.addEventListener('Sync', function (event) {
  console.log('Sync event!')
  if (masqStore) {
    masqStore.getAll().then(function (res) {
        // update your local store
      appData = res || appData
      pre.innerText = JSON.stringify(appData)
    })
  }
})

// Public wrapper around the MasqStore.setAll method
var setAll = function (obj) {
  masqStore.setAll(obj).then(function () {
    pre.innerText = JSON.stringify(obj)
  }).catch(function (err) {
    console.log(err)
  })
}
</script>
</html>