<!DOCTYPE html>
<html lang="en">
<head>
<title>Masq Storage Client</title>
<style>
  html {
    zoom: 2;
  }
  .hidden {
    display: none;
  }
</style>
</head>
<body>
  <h1>Test Masq App</h1>
  <p id="counter" class="hidden">
    <button id="decr">-</button>
    <span id="cntr">0</span>
    <button id="incr">+</button>
  </p>
</body>
<script type="text/javascript" src="../dist/masq.js"></script>
<script>
var decr = document.getElementById('decr')
var incr = document.getElementById('incr')
var cntr = document.getElementById('cntr')
var STORE = 'https://sync-beta.qwantresearch.com/v2/'
var appURL = window.location.origin + window.location.pathname
var regParams = {
  endpoint: STORE,
  url: appURL,
  title: 'Test app',
  desc: 'A generic app that uses Masq for storage',
  icon: 'https://camo.githubusercontent.com/8b35d12bd9682a31446b08c1483145653aa5006f/68747470733a2f2f692e696d6775722e636f6d2f715a33647130512e706e67'
}

var masqStore = new window.MasqClient(STORE)

// Your app data (store)
var appData = {
  counter: 0
}

// Register app if it's the first time we use it
var register = function () {
  var errMsg = document.createElement('span')
  errMsg.id = 'err-msg'
  errMsg.innerHTML = 'Click <a href="#" id="register-app">here</a> to register your application with Masq'
  document.body.appendChild(errMsg)
  document.getElementById('register-app').addEventListener('click', function () {
    masqStore.registerApp(regParams).then(function (e) {
      // window.location.reload()
      errMsg.remove()
      getRemoteData()
    })
  })
}

// Load all remote app state on initial connect
var getRemoteData = function () {
  return masqStore.getAll().then(function (res) {
    var errMsg = document.getElementById('err-msg')
    if (errMsg) {
      errMsg.remove()
    }
    // update your local store
    appData.counter = res.counter || 0
    console.log('Loaded app state:', appData)
    cntr.innerText = appData.counter
    document.getElementById('counter').classList.remove('hidden')
  }).catch(function (err) {
    if (err.message === 'UNREGISTERED') {
      register()
    }
    console.log(err.message)
  })
}

// Refresh app state following a sync event
document.addEventListener('Sync', function (event) {
  console.log('Sync event!')
  if (masqStore) {
    getRemoteData()
  }
})

decr.addEventListener('click', function (event) {
  if (masqStore) {
    appData.counter--
    set('counter', appData.counter)
  }
})

incr.addEventListener('click', function (event) {
  if (masqStore) {
    appData.counter++
    set('counter', appData.counter)
  }
})

// Public wrapper around the MasqStore.set method
var set = function (key, val) {
  masqStore.set(key, val).then(function () {
    cntr.innerText = val
  }).catch(function (err) {
    console.log(err)
  })
}

// Initialize the store
masqStore.onConnect().then(getRemoteData)
</script>
</html>