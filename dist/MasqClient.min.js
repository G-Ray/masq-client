!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).MasqClient=e()}}(function(){return function e(t,n,o){function r(s,c){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!c&&u)return u(s,!0);if(i)return i(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var a=n[s]={exports:{}};t[s][0].call(a.exports,function(e){var n=t[s][1][e];return r(n||e)},a,a.exports,e,t,n,o)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<o.length;s++)r(o[s]);return r}({1:[function(e,t,n){"use strict";var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._storeURL=t||window.location.origin,n=n||{},this._id=this._generateUUID(),this._promise=n.promise||Promise,this._origin=this._getOrigin(this._storeURL),this._requests={},this._connected=!1,this._closed=!1,this._count=0,this._timeout=n.timeout||5e3,this._listener=null,this._regwindow=null,this._installListener(),this._store=n.store||window}return o(e,[{key:"_getOrigin",value:function(e){var t,n,o;return t=document.createElement("a"),t.href=e,t.host||(t=window.location),n=t.protocol&&":"!==t.protocol?t.protocol:window.location.protocol,o=n+"//"+t.host,o=o.replace(/:80$|:443$/,"")}},{key:"_generateUUID",value:function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(e){return(e^window.crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)})}},{key:"onConnect",value:function(){var e=this;return this._connected?this._promise.resolve():this._closed?this._promise.reject(new Error("MasqClient has closed")):(this._requests.connect||(this._requests.connect=[]),new this._promise(function(t,n){var o=setTimeout(function(){n(new Error("MasqClient could not connect to "+e._storeURL))},e._timeout);e._requests.connect.push(function(e){if(clearTimeout(o),e)return n(e);t()})}))}},{key:"registerApp",value:function(e){var t=this;return new Promise(function(n,o){if(void 0===t._regwindow||t._regwindow.closed){e.endpoint=e.endpoint||t._endpoint,e.url||o(new Error("No app URL provided to registerApp()"));var r=e.endpoint+"?add=1&appUrl="+encodeURIComponent(e.url);e.title&&(r+="&title="+encodeURIComponent(e.title)),e.desc&&(r+="&desc="+encodeURIComponent(e.desc)),e.icon&&(r+="&icon="+encodeURIComponent(e.icon));var i=void 0!==window.screenLeft?window.screenLeft:window.screen.left,s=void 0!==window.screenTop?window.screenTop:window.screen.top,c=(window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:window.screen.width)/2-200+i,u=(window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:window.screen.height)/2-300+s;t._regwindow=window.open(r,"","scrollbars=yes, width=400, height=600, top="+u+", left="+c),window.focus&&t._regwindow.focus(),window.addEventListener("message",function(e){"REGISTRATIONFINISHED"===e.data&&n(e)},!1)}})}},{key:"set",value:function(e,t){return this._request("set",{key:e,value:t})}},{key:"get",value:function(e){var t=Array.prototype.slice.call(arguments);return this._request("get",{keys:t})}},{key:"del",value:function(){var e=Array.prototype.slice.call(arguments);return this._request("del",{keys:e})}},{key:"clear",value:function(){return this._request("clear")}},{key:"getAll",value:function(){return this._request("getAll")}},{key:"setAll",value:function(e){return this._request("setAll",e)}},{key:"user",value:function(){return this._request("user")}},{key:"close",value:function(){window.removeEventListener?window.removeEventListener("message",this._listener,!1):window.detachEvent("onmessage",this._listener),this._connected=!1,this._closed=!0}},{key:"_installListener",value:function(){var e=this;this._listener=function(t){var n,o,r;if(!e._closed&&t.data&&("null"===t.origin?"file://":t.origin)===e._origin)if("unavailable"!==t.data["cross-storage"]){if(t.data["cross-storage"]&&!e._connected){if("listening"===t.data["cross-storage"])return void e._init();if(e._connected=!0,!e._requests.connect)return;for(n=0;n<e._requests.connect.length;n++)e._requests.connect[n](o);delete e._requests.connect}if("ready"!==t.data["cross-storage"]){try{r=t.data}catch(e){return}if(r.client){if(console.log("receive response"),console.log(r),t.data.sync){var i=new window.CustomEvent("Sync");document.dispatchEvent(i)}e._requests[r.client]&&e._requests[r.client](r.error,r.result)}}}else{if(e._closed||e.close(),!e._requests.connect)return;for(o=new Error("Closing client. Could not access localStorage in store."),n=0;n<e._requests.connect.length;n++)e._requests.connect[n](o)}},window.addEventListener?window.addEventListener("message",this._listener,!1):window.attachEvent("onmessage",this._listener)}},{key:"_init",value:function(){var e,t,n;n="file://"===(e=this)._origin?"*":e._origin,t=setInterval(function(){if(e._connected)return clearInterval(t);e._store&&e._store.postMessage({"cross-storage":"init"},n)},100)}},{key:"_request",value:function(e,t){var n,o;return this._closed?this._promise.reject(new Error("MasqClient has closed")):(o=this,o._count++,n={client:this._id+":"+o._count,method:e,params:t},new this._promise(function(e,t){var r,i,s;r=setTimeout(function(){o._requests[n.client]&&(delete o._requests[n.client],t(new Error("Timeout: could not perform "+n.method)))},o._timeout),o._requests[n.client]=function(i,s){if(clearTimeout(r),delete o._requests[n.client],i)return t(new Error(i));e(s)},window.Array.prototype.toJSON&&(i=Array.prototype.toJSON,window.Array.prototype.toJSON=null),s="file://"===o._origin?"*":o._origin,o._store.postMessage(n,s),i&&(window.Array.prototype.toJSON=i)}))}}]),e}();void 0!==t&&t.exports?t.exports=r:void 0!==n?n.MasqClient=r:root.MasqClient=r},{}]},{},[1])(1)});